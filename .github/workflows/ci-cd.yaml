name: NodeJS CI/CD Pipeline

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      NEXUS_USER: ${{ secrets.NEXUS_USER }}
      NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
      NEXUS_HOST: ${{ secrets.NEXUS_HOST }}
      DOCKER_USER: ${{ secrets.DOCKER_USER }}
      DOCKER_PASS: ${{ secrets.DOCKER_PASS }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Debug Secrets Presence (no values exposed)
        run: |
          echo "SONAR_TOKEN: ${SONAR_TOKEN:+set}"
          echo "NEXUS_HOST: ${NEXUS_HOST:+set}"
          echo "DOCKER_USER: ${DOCKER_USER:+set}"

      - name: Validate Sonar Token Exists
        run: |
          if [ -z "$SONAR_TOKEN" ]; then
            echo "::error ::SONAR_TOKEN is missing. Add it in: GitHub → Repo → Settings → Secrets → Actions"
            exit 1
          fi

      - name: SonarQube Scan (Using CLI via Docker)
        run: |
          SONAR_HOST="http://3.95.246.128:9000"
          SONAR_TOKEN="${{ secrets.SONAR_TOKEN }}"

          echo "Testing connectivity to SonarQube at $SONAR_HOST"
          curl -v --max-time 10 "$SONAR_HOST/api/server/version"

          echo "Running Sonar Scanner..."
          docker run --rm \
            -v "${GITHUB_WORKSPACE}":/usr/src \
            -w /usr/src \
            sonarsource/sonar-scanner-cli \
            sonar-scanner \
              -Dsonar.projectKey=nodeapp \
              -Dsonar.sources=. \
              -Dsonar.host.url="$SONAR_HOST" \
              -Dsonar.login="$SONAR_TOKEN"

      - name: Create TAR Artifact
        run: tar -czf nodeapp.tar.gz *

      - name: Upload to Nexus (RAW Repository)
        run: |
          if [ -z "${NEXUS_HOST}" ]; then
            echo "::error ::NEXUS_HOST secret is missing"
            exit 1
          fi

          curl -v -u "${NEXUS_USER}:${NEXUS_PASS}" \
            --upload-file nodeapp.tar.gz \
            "${NEXUS_HOST}/repository/nodejs/nodeapp.tar.gz"

      - name: Build Docker Image
        run: |
          docker build -t "${{ secrets.DOCKER_USER }}/nodeapp:latest" .

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      - name: Push Docker Image
        run: docker push "${{ secrets.DOCKER_USER }}/nodeapp:latest"
